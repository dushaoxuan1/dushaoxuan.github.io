<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>可自定义标书数量的多周期确认系统</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind自定义颜色和字体 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
            neutral: '#86909C'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .transition-custom {
        transition: all 0.3s ease;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- 页面标题 -->
    <header class="mb-6 text-center">
      <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-gray-800 mb-2">可自定义标书数量的多周期确认系统</h1>
      <p class="text-gray-500">每个日期周期内的标书确认状态跟踪（3-6份）</p>
      <div class="mt-4 flex flex-wrap justify-center gap-4 items-center text-sm">
        <div class="flex items-center">
          <span class="inline-block w-3 h-3 rounded-full bg-success mr-2"></span>
          <span>已确认</span>
        </div>
        <div class="flex items-center">
          <span class="inline-block w-3 h-3 rounded-full bg-danger mr-2"></span>
          <span>未确认</span>
        </div>
        <div class="flex items-center">
          <span class="inline-block w-3 h-3 rounded-full bg-warning mr-2"></span>
          <span>部分确认</span>
        </div>
      </div>
    </header>
    
    <!-- 功能按钮区 -->
    <div class="flex flex-wrap justify-end gap-3 mb-6">
      <button id="manageBidsBtn" class="px-3 py-1.5 bg-primary/80 text-white rounded-lg hover:bg-primary/90 text-sm flex items-center transition-custom">
        <i class="fa fa-file-text-o mr-1"></i> 管理标书数量
      </button>
      <button id="managePeopleBtn" class="px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm flex items-center transition-custom">
        <i class="fa fa-users mr-1"></i> 管理人员
      </button>
      <button id="assignPeopleBtn" class="px-3 py-1.5 bg-primary/80 text-white rounded-lg hover:bg-primary/90 text-sm flex items-center transition-custom">
        <i class="fa fa-exchange mr-1"></i> 分配负责人
      </button>
    </div>
    
    <!-- 日期周期管理 -->
    <div class="bg-white rounded-xl p-5 card-shadow mb-6">
      <div class="flex flex-wrap justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-gray-800">日期周期管理</h2>
        <button id="addPeriodBtn" class="px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm flex items-center transition-custom">
          <i class="fa fa-plus mr-1"></i> 添加周期
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-3" id="periodsContainer">
        <!-- 周期1 -->
        <div class="period-item bg-gray-50 p-3 rounded-lg border border-gray-200 cursor-pointer transition-custom hover:border-primary active" data-period="1">
          <div class="font-medium">周期 1</div>
          <div class="text-sm text-gray-500 mt-1">2025-10-25 至 2025-10-31</div>
          <div class="flex justify-end mt-2">
            <button class="edit-period text-primary text-xs flex items-center" data-period="1">
              <i class="fa fa-pencil mr-1"></i> 编辑
            </button>
          </div>
        </div>
        
        <!-- 周期2 -->
        <div class="period-item bg-gray-50 p-3 rounded-lg border border-gray-200 cursor-pointer transition-custom hover:border-primary" data-period="2">
          <div class="font-medium">周期 2</div>
          <div class="text-sm text-gray-500 mt-1">2025-11-01 至 2025-11-07</div>
          <div class="flex justify-end mt-2">
            <button class="edit-period text-primary text-xs flex items-center" data-period="2">
              <i class="fa fa-pencil mr-1"></i> 编辑
            </button>
          </div>
        </div>
        
        <!-- 周期3 -->
        <div class="period-item bg-gray-50 p-3 rounded-lg border border-gray-200 cursor-pointer transition-custom hover:border-primary" data-period="3">
          <div class="font-medium">周期 3</div>
          <div class="text-sm text-gray-500 mt-1">2025-11-08 至 2025-11-14</div>
          <div class="flex justify-end mt-2">
            <button class="edit-period text-primary text-xs flex items-center" data-period="3">
              <i class="fa fa-pencil mr-1"></i> 编辑
            </button>
          </div>
        </div>
        
        <!-- 周期4 -->
        <div class="period-item bg-gray-50 p-3 rounded-lg border border-gray-200 cursor-pointer transition-custom hover:border-primary" data-period="4">
          <div class="font-medium">周期 4</div>
          <div class="text-sm text-gray-500 mt-1">2025-11-15 至 2025-11-21</div>
          <div class="flex justify-end mt-2">
            <button class="edit-period text-primary text-xs flex items-center" data-period="4">
              <i class="fa fa-pencil mr-1"></i> 编辑
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 当前周期标书确认状态 -->
    <div class="mb-6" id="currentPeriodContent">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-gray-800" id="currentPeriodTitle">周期 1 (2025-10-25 至 2025-10-31) 标书确认状态</h2>
        <div class="text-sm text-green-600 flex items-center" id="syncStatus">
          <i class="fa fa-check-circle mr-1"></i>
          <span>已同步</span>
        </div>
      </div>
      
      <!-- 标书确认表格 -->
      <div class="overflow-x-auto bg-white rounded-xl card-shadow">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                标书编号
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                负责人员
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                确认状态
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="bidConfirmationTable">
            <!-- 标书内容将通过JS动态生成 -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- 周期汇总统计 -->
    <div class="bg-white rounded-xl p-5 card-shadow mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">当前周期汇总统计</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="p-4 rounded-lg bg-gray-50">
          <div class="text-gray-500 text-sm mb-1">已完成确认</div>
          <div class="flex items-end">
            <span class="text-2xl font-bold text-success" id="period-completed">1</span>
            <span class="text-gray-500 ml-2 mb-0.5" id="completed-total">/4 份标书</span>
          </div>
        </div>
        <div class="p-4 rounded-lg bg-gray-50">
          <div class="text-gray-500 text-sm mb-1">部分确认</div>
          <div class="flex items-end">
            <span class="text-2xl font-bold text-warning" id="period-partial">1</span>
            <span class="text-gray-500 ml-2 mb-0.5" id="partial-total">/4 份标书</span>
          </div>
        </div>
        <div class="p-4 rounded-lg bg-gray-50">
          <div class="text-gray-500 text-sm mb-1">未确认</div>
          <div class="flex items-end">
            <span class="text-2xl font-bold text-danger" id="period-pending">2</span>
            <span class="text-gray-500 ml-2 mb-0.5" id="pending-total">/4 份标书</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 操作日志 -->
    <div class="bg-white rounded-xl p-5 card-shadow mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-3">操作日志</h2>
      <div class="space-y-2 max-h-40 overflow-y-auto pr-2 text-sm" id="log-container">
        <div class="text-gray-500 italic">暂无操作记录</div>
      </div>
    </div>
  </div>
  
  <!-- 编辑周期的模态框 -->
  <div id="periodModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-5 w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800" id="periodModalTitle">编辑周期 1</h3>
        <button id="closePeriodModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-700 mb-1">周期名称</label>
          <input type="text" id="periodName" class="w-full p-2 border border-gray-300 rounded-md" placeholder="例如：周期 1">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-700 mb-1">开始日期</label>
            <input type="date" id="periodStart" class="w-full p-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">结束日期</label>
            <input type="date" id="periodEnd" class="w-full p-2 border border-gray-300 rounded-md">
          </div>
        </div>
      </div>
      
      <input type="hidden" id="currentPeriodId">
      
      <div class="mt-5 flex justify-end gap-3">
        <button id="deletePeriodBtn" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-danger/90 transition-custom">
          删除周期
        </button>
        <button id="savePeriodBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom">
          保存设置
        </button>
      </div>
    </div>
  </div>
  
  <!-- 人员管理模态框 -->
  <div id="peopleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-5 w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">管理人员</h3>
        <button id="closePeopleModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="mb-4">
        <div class="flex gap-2">
          <input type="text" id="newPersonName" class="flex-1 p-2 border border-gray-300 rounded-md" placeholder="输入人员姓名">
          <button id="addPersonBtn" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom">
            <i class="fa fa-plus"></i>
          </button>
        </div>
      </div>
      
      <div class="space-y-2 max-h-60 overflow-y-auto pr-2" id="peopleList">
        <!-- 人员列表将通过JS动态生成 -->
      </div>
      
      <div class="mt-5 flex justify-end">
        <button id="closePeopleBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-custom">
          关闭
        </button>
      </div>
    </div>
  </div>
  
  <!-- 分配负责人模态框 -->
  <div id="assignModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-5 w-full max-w-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">分配标书负责人</h3>
        <button id="closeAssignModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-6" id="assignmentContainer">
        <!-- 分配内容将通过JS动态生成 -->
      </div>
      
      <div class="mt-5 flex justify-end">
        <button id="saveAssignmentBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom">
          保存分配
        </button>
      </div>
    </div>
  </div>
  
  <!-- 管理标书数量模态框 -->
  <div id="bidCountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-5 w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">设置标书数量</h3>
        <button id="closeBidCountModal" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-700 mb-2">请选择标书数量（3-6份）</label>
          <input type="range" id="bidCountSlider" min="3" max="6" value="4" 
                 class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
          <div class="flex justify-between text-sm text-gray-500 mt-1">
            <span>3份</span>
            <span id="bidCountValue">4份</span>
            <span>6份</span>
          </div>
        </div>
        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md text-sm text-yellow-700">
          <i class="fa fa-info-circle mr-1"></i>
          更改标书数量会重置所有标书的负责人分配，请谨慎操作
        </div>
      </div>
      
      <div class="mt-5 flex justify-end">
        <button id="saveBidCountBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom">
          确认设置
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // 全局变量
    let currentPeriod = 1;
    let people = ["张三", "李四", "王五", "赵六", "钱七", "孙八", "周九", "吴十"];
    let bidCount = 4; // 标书数量，3-6之间
    let bidGroups = [
      ["张三", "李四"],   // 标书1
      ["王五", "赵六"],   // 标书2
      ["钱七", "孙八"],   // 标书3
      ["周九", "吴十"]    // 标书4
    ];
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
      // 从本地存储加载数据
      loadFromLocalStorage();
      
      // 初始化标书表格
      renderBidTable();
      
      // 周期切换事件
      const periodItems = document.querySelectorAll('.period-item');
      periodItems.forEach(item => {
        item.addEventListener('click', function(e) {
          // 如果点击的是编辑按钮，不切换周期
          if (e.target.closest('.edit-period')) return;
          
          // 移除其他周期的活跃状态
          document.querySelectorAll('.period-item').forEach(el => {
            el.classList.remove('active', 'border-primary', 'bg-primary/5');
            el.classList.add('border-gray-200');
          });
          
          // 添加当前周期的活跃状态
          this.classList.add('active', 'border-primary', 'bg-primary/5');
          this.classList.remove('border-gray-200');
          
          // 更新当前周期
          currentPeriod = parseInt(this.dataset.period);
          updateCurrentPeriodContent();
          updatePeriodStats();
        });
      });
      
      // 编辑周期按钮事件
      const editButtons = document.querySelectorAll('.edit-period');
      editButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.stopPropagation();
          const periodId = this.dataset.period;
          openPeriodModal(periodId, 'edit');
        });
      });
      
      // 添加周期按钮事件
      document.getElementById('addPeriodBtn').addEventListener('click', function() {
        const newPeriodId = document.querySelectorAll('.period-item').length + 1;
        openPeriodModal(newPeriodId, 'add');
      });
      
      // 关闭周期模态框
      document.getElementById('closePeriodModal').addEventListener('click', function() {
        document.getElementById('periodModal').classList.add('hidden');
      });
      
      // 保存周期设置
      document.getElementById('savePeriodBtn').addEventListener('click', function() {
        savePeriodSettings();
      });
      
      // 删除周期
      document.getElementById('deletePeriodBtn').addEventListener('click', function() {
        if (confirm('确定要删除这个周期吗？相关的确认数据也会被删除。')) {
          deletePeriod();
        }
      });
      
      // 确认状态变更事件委托
      document.getElementById('bidConfirmationTable').addEventListener('change', function(e) {
        if (e.target.type === 'checkbox') {
          handleConfirmationChange(e.target);
        }
      });
      
      // 人员管理按钮
      document.getElementById('managePeopleBtn').addEventListener('click', function() {
        openPeopleModal();
      });
      
      // 关闭人员管理模态框
      document.getElementById('closePeopleModal').addEventListener('click', function() {
        document.getElementById('peopleModal').classList.add('hidden');
      });
      
      document.getElementById('closePeopleBtn').addEventListener('click', function() {
        document.getElementById('peopleModal').classList.add('hidden');
      });
      
      // 添加人员
      document.getElementById('addPersonBtn').addEventListener('click', function() {
        const nameInput = document.getElementById('newPersonName');
        const name = nameInput.value.trim();
        
        if (name && !people.includes(name)) {
          people.push(name);
          savePeopleData();
          renderPeopleList();
          nameInput.value = '';
          showSyncIndicator();
        }
      });
      
      // 分配负责人按钮
      document.getElementById('assignPeopleBtn').addEventListener('click', function() {
        openAssignModal();
      });
      
      // 关闭分配负责人模态框
      document.getElementById('closeAssignModal').addEventListener('click', function() {
        document.getElementById('assignModal').classList.add('hidden');
      });
      
      // 保存分配设置
      document.getElementById('saveAssignmentBtn').addEventListener('click', function() {
        saveAssignmentSettings();
      });
      
      // 管理标书数量按钮
      document.getElementById('manageBidsBtn').addEventListener('click', function() {
        openBidCountModal();
      });
      
      // 关闭标书数量模态框
      document.getElementById('closeBidCountModal').addEventListener('click', function() {
        document.getElementById('bidCountModal').classList.add('hidden');
      });
      
      // 标书数量滑块事件
      const bidCountSlider = document.getElementById('bidCountSlider');
      const bidCountValue = document.getElementById('bidCountValue');
      
      bidCountSlider.addEventListener('input', function() {
        bidCountValue.textContent = `${this.value}份`;
      });
      
      // 保存标书数量设置
      document.getElementById('saveBidCountBtn').addEventListener('click', function() {
        const newBidCount = parseInt(document.getElementById('bidCountSlider').value);
        
        if (newBidCount !== bidCount) {
          if (confirm(`确定要将标书数量改为${newBidCount}份吗？这将重置所有标书的负责人分配。`)) {
            bidCount = newBidCount;
            resetBidGroups(); // 重置标书负责人分配
            saveBidCountData();
            saveBidGroupsData();
            
            // 重新渲染界面
            renderBidTable();
            updateCurrentPeriodContent();
            updatePeriodStats();
            
            // 关闭模态框
            document.getElementById('bidCountModal').classList.add('hidden');
            
            // 记录日志
            logAction('系统', currentPeriod, 'all', true, `将标书数量调整为${newBidCount}份`);
            
            // 显示同步提示
            showSyncIndicator();
          }
        } else {
          document.getElementById('bidCountModal').classList.add('hidden');
        }
      });
      
      // 监听本地存储变化，实现多窗口同步
      window.addEventListener('storage', function(e) {
        if (['bidConfirmationData', 'periodData', 'logData', 'peopleData', 'bidGroupsData', 'bidCountData'].includes(e.key)) {
          loadFromLocalStorage();
          renderBidTable();
          updateCurrentPeriodContent();
          updatePeriodStats();
          
          // 显示同步提示
          const syncStatus = document.getElementById('syncStatus');
          syncStatus.innerHTML = '<i class="fa fa-refresh mr-1"></i><span>已更新</span>';
          syncStatus.classList.add('text-primary');
          
          setTimeout(() => {
            syncStatus.innerHTML = '<i class="fa fa-check-circle mr-1"></i><span>已同步</span>';
            syncStatus.classList.remove('text-primary');
          }, 2000);
        }
      });
    });
    
    // 渲染标书表格
    function renderBidTable() {
      const tableBody = document.getElementById('bidConfirmationTable');
      tableBody.innerHTML = '';
      
      // 为每份标书创建一行
      for (let i = 0; i < bidCount; i++) {
        const bidNumber = i + 1;
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">标书 #${bidNumber}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex flex-wrap gap-2" id="bid-${bidNumber}-people">
              <!-- 负责人将通过JS动态生成 -->
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="bid-status px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-danger text-white">
              未确认
            </span>
          </td>
        `;
        
        tableBody.appendChild(row);
      }
    }
    
    // 重置标书负责人分配
    function resetBidGroups() {
      bidGroups = [];
      
      // 为每份标书创建空的负责人数组
      for (let i = 0; i < bidCount; i++) {
        bidGroups.push([]);
      }
      
      // 如果有人员，尝试自动分配
      if (people.length > 0) {
        for (let i = 0; i < bidCount; i++) {
          // 为每份标书分配前两名人员（如果存在）
          if (i < people.length) {
            bidGroups[i].push(people[i]);
          }
          if (i + bidCount < people.length) {
            bidGroups[i].push(people[i + bidCount]);
          }
        }
      }
    }
    
    // 处理确认状态变更
    function handleConfirmationChange(checkbox) {
      const period = checkbox.dataset.period;
      const bid = checkbox.dataset.bid;
      const person = checkbox.dataset.person;
      const isChecked = checkbox.checked;
      
      // 更新状态
      updateBidStatus(period, bid);
      updatePeriodStats();
      
      // 记录日志
      logAction(person, period, bid, isChecked);
      
      // 保存到本地存储
      saveToLocalStorage();
      
      // 显示同步提示
      showSyncIndicator();
    }
    
    // 更新标书状态
    function updateBidStatus(period, bid) {
      const bidRow = document.querySelector(`input[data-period="${period}"][data-bid="${bid}"]`).closest('tr');
      const checkboxes = bidRow.querySelectorAll(`input[data-period="${period}"][data-bid="${bid}"]`);
      const statusElement = bidRow.querySelector('.bid-status');
      
      // 计算已确认数量
      let checkedCount = 0;
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) checkedCount++;
      });
      
      // 更新状态指示器
      if (checkedCount === 0) {
        statusElement.textContent = '未确认';
        statusElement.className = 'bid-status px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-danger text-white';
      } else if (checkedCount === checkboxes.length) {
        statusElement.textContent = '已确认';
        statusElement.className = 'bid-status px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-success text-white';
      } else {
        statusElement.textContent = '部分确认';
        statusElement.className = 'bid-status px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-warning text-white';
      }
    }
    
    // 更新当前周期内容
    function updateCurrentPeriodContent() {
      // 更新标题
      const periodItem = document.querySelector(`.period-item[data-period="${currentPeriod}"]`);
      const periodName = periodItem.querySelector('.font-medium').textContent;
      const periodDate = periodItem.querySelector('.text-gray-500').textContent;
      document.getElementById('currentPeriodTitle').textContent = `${periodName} (${periodDate}) 标书确认状态`;
      
      // 加载当前周期的确认状态
      const confirmationData = getConfirmationData();
      
      // 更新每个标书的负责人和确认状态
      for (let i = 0; i < bidCount; i++) {
        const bidNumber = i + 1;
        const group = bidGroups[i] || [];
        const peopleContainer = document.getElementById(`bid-${bidNumber}-people`);
        peopleContainer.innerHTML = '';
        
        // 添加负责人复选框
        group.forEach(person => {
          if (person) { // 只添加有值的人员
            const isChecked = confirmationData[currentPeriod]?.[bidNumber]?.[person] || false;
            
            const label = document.createElement('label');
            label.className = 'inline-flex items-center p-1.5 bg-gray-100 rounded border border-gray-200';
            label.innerHTML = `
              <input type="checkbox" class="form-checkbox h-4 w-4 text-primary rounded mr-1" 
                     data-period="${currentPeriod}" data-bid="${bidNumber}" data-person="${person}" ${isChecked ? 'checked' : ''}>
              <span class="text-sm">${person}</span>
            `;
            
            peopleContainer.appendChild(label);
          }
        });
        
        // 更新标书状态显示
        updateBidStatus(currentPeriod, bidNumber);
      }
    }
    
    // 更新周期统计
    function updatePeriodStats() {
      let completed = 0;
      let partial = 0;
      let pending = 0;
      
      // 检查当前周期每个标书的状态
      const bidStatuses = document.querySelectorAll('#bidConfirmationTable .bid-status');
      bidStatuses.forEach(status => {
        if (status.textContent === '已确认') {
          completed++;
        } else if (status.textContent === '部分确认') {
          partial++;
        } else {
          pending++;
        }
      });
      
      // 更新统计数字和总数显示
      document.getElementById('period-completed').textContent = completed;
      document.getElementById('period-partial').textContent = partial;
      document.getElementById('period-pending').textContent = pending;
      
      document.getElementById('completed-total').textContent = `/${bidCount} 份标书`;
      document.getElementById('partial-total').textContent = `/${bidCount} 份标书`;
      document.getElementById('pending-total').textContent = `/${bidCount} 份标书`;
    }
    
    // 打开周期编辑模态框
    function openPeriodModal(periodId, mode) {
      const modal = document.getElementById('periodModal');
      const modalTitle = document.getElementById('periodModalTitle');
      const periodNameInput = document.getElementById('periodName');
      const periodStartInput = document.getElementById('periodStart');
      const periodEndInput = document.getElementById('periodEnd');
      const currentPeriodIdInput = document.getElementById('currentPeriodId');
      const deleteBtn = document.getElementById('deletePeriodBtn');
      
      // 设置模态框标题
      modalTitle.textContent = mode === 'add' ? `添加新周期` : `编辑周期 ${periodId}`;
      currentPeriodIdInput.value = periodId;
      
      // 隐藏或显示删除按钮
      deleteBtn.style.display = mode === 'add' ? 'none' : 'inline-block';
      
      if (mode === 'edit') {
        // 加载现有周期数据
        const periodItem = document.querySelector(`.period-item[data-period="${periodId}"]`);
        const periodName = periodItem.querySelector('.font-medium').textContent;
        const periodDate = periodItem.querySelector('.text-gray-500').textContent;
        const [startDate, endDate] = periodDate.split(' 至 ');
        
        periodNameInput.value = periodName;
        periodStartInput.value = startDate;
        periodEndInput.value = endDate;
      } else {
        // 新增周期，设置默认值
        const today = new Date().toISOString().split('T')[0];
        const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        periodNameInput.value = `周期 ${periodId}`;
        periodStartInput.value = today;
        periodEndInput.value = nextWeek;
      }
      
      // 显示模态框
      modal.classList.remove('hidden');
    }
    
    // 保存周期设置
    function savePeriodSettings() {
      const periodId = document.getElementById('currentPeriodId').value;
      const periodName = document.getElementById('periodName').value;
      const startDate = document.getElementById('periodStart').value;
      const endDate = document.getElementById('periodEnd').value;
      
      if (!periodName || !startDate || !endDate) {
        alert('请填写完整的周期信息');
        return;
      }
      
      // 检查日期有效性
      if (new Date(startDate) > new Date(endDate)) {
        alert('开始日期不能晚于结束日期');
        return;
      }
      
      // 更新或创建周期元素
      let periodItem = document.querySelector(`.period-item[data-period="${periodId}"]`);
      
      if (periodItem) {
        // 更新现有周期
        periodItem.querySelector('.font-medium').textContent = periodName;
        periodItem.querySelector('.text-gray-500').textContent = `${startDate} 至 ${endDate}`;
      } else {
        // 创建新周期
        const periodsContainer = document.getElementById('periodsContainer');
        periodItem = document.createElement('div');
        periodItem.className = 'period-item bg-gray-50 p-3 rounded-lg border border-gray-200 cursor-pointer transition-custom hover:border-primary';
        periodItem.dataset.period = periodId;
        periodItem.innerHTML = `
          <div class="font-medium">${periodName}</div>
          <div class="text-sm text-gray-500 mt-1">${startDate} 至 ${endDate}</div>
          <div class="flex justify-end mt-2">
            <button class="edit-period text-primary text-xs flex items-center" data-period="${periodId}">
              <i class="fa fa-pencil mr-1"></i> 编辑
            </button>
          </div>
        `;
        
        periodsContainer.appendChild(periodItem);
        
        // 为新周期添加点击事件
        periodItem.addEventListener('click', function(e) {
          if (e.target.closest('.edit-period')) return;
          
          document.querySelectorAll('.period-item').forEach(el => {
            el.classList.remove('active', 'border-primary', 'bg-primary/5');
            el.classList.add('border-gray-200');
          });
          
          this.classList.add('active', 'border-primary', 'bg-primary/5');
          this.classList.remove('border-gray-200');
          
          currentPeriod = parseInt(this.dataset.period);
          updateCurrentPeriodContent();
          updatePeriodStats();
        });
        
        // 为编辑按钮添加事件
        periodItem.querySelector('.edit-period').addEventListener('click', function(e) {
          e.stopPropagation();
          openPeriodModal(periodId, 'edit');
        });
      }
      
      // 保存周期数据
      savePeriodData();
      
      // 关闭模态框
      document.getElementById('periodModal').classList.add('hidden');
      
      // 如果是当前周期，更新标题
      if (parseInt(periodId) === currentPeriod) {
        document.getElementById('currentPeriodTitle').textContent = `${periodName} (${startDate} 至 ${endDate}) 标书确认状态`;
      }
      
      // 显示同步提示
      showSyncIndicator();
    }
    
    // 删除周期
    function deletePeriod() {
      const periodId = document.getElementById('currentPeriodId').value;
      
      // 如果删除的是当前周期，切换到第一个周期
      if (parseInt(periodId) === currentPeriod && document.querySelectorAll('.period-item').length > 1) {
        currentPeriod = 1;
        document.querySelectorAll('.period-item')[0].click();
      }
      
      // 从DOM中移除
      const periodItem = document.querySelector(`.period-item[data-period="${periodId}"]`);
      if (periodItem) {
        periodItem.remove();
      }
      
      // 从存储中删除
      const periodData = getPeriodData();
      delete periodData[periodId];
      localStorage.setItem('periodData', JSON.stringify(periodData));
      
      // 删除相关的确认数据
      const confirmationData = getConfirmationData();
      delete confirmationData[periodId];
      localStorage.setItem('bidConfirmationData', JSON.stringify(confirmationData));
      
      // 关闭模态框
      document.getElementById('periodModal').classList.add('hidden');
      
      // 显示同步提示
      showSyncIndicator();
    }
    
    // 打开人员管理模态框
    function openPeopleModal() {
      const modal = document.getElementById('peopleModal');
      renderPeopleList();
      modal.classList.remove('hidden');
    }
    
    // 渲染人员列表
    function renderPeopleList() {
      const peopleListContainer = document.getElementById('peopleList');
      peopleListContainer.innerHTML = '';
      
      if (people.length === 0) {
        peopleListContainer.innerHTML = '<div class="text-gray-500 text-sm italic">暂无人员，请添加</div>';
        return;
      }
      
      people.forEach((person, index) => {
        const personItem = document.createElement('div');
        personItem.className = 'flex justify-between items-center p-2 border-b border-gray-100 last:border-0';
        personItem.innerHTML = `
          <span>${person}</span>
          <button class="delete-person text-danger text-sm" data-index="${index}">
            <i class="fa fa-trash"></i>
          </button>
        `;
        
        peopleListContainer.appendChild(personItem);
      });
      
      // 为删除按钮添加事件
      document.querySelectorAll('.delete-person').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          const personName = people[index];
          
          // 检查该人员是否被分配了标书
          const isAssigned = bidGroups.some(group => group.includes(personName));
          
          if (isAssigned) {
            if (!confirm(`"${personName}" 已被分配负责标书，删除后需要重新分配。确定要删除吗？`)) {
              return;
            }
            
            // 从标书分配中移除该人员
            for (let i = 0; i < bidGroups.length; i++) {
              bidGroups[i] = bidGroups[i].filter(p => p !== personName);
            }
            saveBidGroupsData();
          }
          
          // 删除人员
          people.splice(index, 1);
          savePeopleData();
          renderPeopleList();
          renderBidTable();
          updateCurrentPeriodContent();
          showSyncIndicator();
        });
      });
    }
    
    // 打开分配负责人模态框
    function openAssignModal() {
      const modal = document.getElementById('assignModal');
      const container = document.getElementById('assignmentContainer');
      container.innerHTML = '';
      
      // 为每份标书创建分配选项
      for (let i = 0; i < bidCount; i++) {
        const bidNumber = i + 1;
        const group = bidGroups[i] || [];
        const bidAssignment = document.createElement('div');
        
        let peopleOptions = '';
        people.forEach(person => {
          const isSelected1 = group.length >= 1 && group[0] === person;
          const isSelected2 = group.length >= 2 && group[1] === person;
          peopleOptions += `<option value="${person}" ${isSelected1 || isSelected2 ? 'selected' : ''}>${person}</option>`;
        });
        
        bidAssignment.innerHTML = `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">标书 #${bidNumber}</label>
            <div class="flex gap-3">
              <select class="bid-person-select flex-1 p-2 border border-gray-300 rounded-md" data-bid="${bidNumber}" data-index="0">
                <option value="">选择负责人 1</option>
                ${peopleOptions}
              </select>
              <select class="bid-person-select flex-1 p-2 border border-gray-300 rounded-md" data-bid="${bidNumber}" data-index="1">
                <option value="">选择负责人 2</option>
                ${peopleOptions}
              </select>
            </div>
          </div>
        `;
        
        container.appendChild(bidAssignment);
      }
      
      // 为选择框添加事件，防止选择相同人员
      document.querySelectorAll('.bid-person-select').forEach(select => {
        select.addEventListener('change', function() {
          const bidNumber = this.dataset.bid;
          const index = this.dataset.index;
          const otherIndex = index === '0' ? '1' : '0';
          const otherSelect = document.querySelector(`.bid-person-select[data-bid="${bidNumber}"][data-index="${otherIndex}"]`);
          
          // 如果两个选择了相同的人，清空另一个
          if (this.value && this.value === otherSelect.value) {
            otherSelect.value = '';
          }
        });
      });
      
      modal.classList.remove('hidden');
    }
    
    // 保存分配设置
    function saveAssignmentSettings() {
      const selects = document.querySelectorAll('.bid-person-select');
      const newBidGroups = [];
      
      // 初始化新的分配数组
      for (let i = 0; i < bidCount; i++) {
        newBidGroups.push([]);
      }
      
      selects.forEach(select => {
        const bidNumber = parseInt(select.dataset.bid) - 1; // 转为索引
        const index = parseInt(select.dataset.index);
        const person = select.value;
        
        if (person) {
          newBidGroups[bidNumber][index] = person;
        }
      });
      
      // 验证所有标书都分配了至少一人
      let valid = true;
      newBidGroups.forEach((group, index) => {
        if (group.filter(Boolean).length === 0) {
          valid = false;
          alert(`标书 #${index + 1} 至少需要分配一名负责人`);
        }
      });
      
      if (!valid) return;
      
      // 保存新的分配方案
      bidGroups = newBidGroups;
      saveBidGroupsData();
      
      // 重新渲染表格并更新状态
      renderBidTable();
      updateCurrentPeriodContent();
      updatePeriodStats();
      
      // 关闭模态框
      document.getElementById('assignModal').classList.add('hidden');
      
      // 记录日志
      logAction('系统', currentPeriod, 'all', true, '更新了标书负责人分配');
      
      // 显示同步提示
      showSyncIndicator();
    }
    
    // 打开标书数量设置模态框
    function openBidCountModal() {
      const modal = document.getElementById('bidCountModal');
      const slider = document.getElementById('bidCountSlider');
      const valueDisplay = document.getElementById('bidCountValue');
      
      slider.value = bidCount;
      valueDisplay.textContent = `${bidCount}份`;
      
      modal.classList.remove('hidden');
    }
    
    // 记录操作日志
    function logAction(person, period, bid, isChecked, customAction = '') {
      const logContainer = document.getElementById('log-container');
      let actionText = customAction;
      
      if (!actionText) {
        actionText = isChecked ? '确认了' : '取消了';
      }
      
      const now = new Date();
      const timeString = now.toLocaleString();
      
      // 获取周期名称
      const periodItem = document.querySelector(`.period-item[data-period="${period}"]`);
      const periodName = periodItem ? periodItem.querySelector('.font-medium').textContent : `周期 ${period}`;
      
      // 操作对象文本
      const targetText = bid === 'all' ? '所有标书' : `标书 #${bid}`;
      
      // 创建新日志条目
      const logEntry = document.createElement('div');
      logEntry.className = 'flex justify-between items-center p-1.5 border-b border-gray-100 last:border-0';
      logEntry.innerHTML = `
        <span><strong>${person}</strong> ${actionText} ${periodName} 的 ${targetText}</span>
        <span class="text-gray-400">${timeString}</span>
      `;
      
      // 如果是第一条日志，清除"暂无记录"提示
      if (logContainer.querySelector('.italic')) {
        logContainer.innerHTML = '';
      }
      
      // 添加到日志容器顶部
      logContainer.insertBefore(logEntry, logContainer.firstChild);
      
      // 保存日志到本地存储
      saveLogEntry({
        person,
        period,
        bid,
        action: customAction || (isChecked ? 'confirm' : 'cancel'),
        time: timeString,
        timestamp: now.getTime()
      });
    }
    
    // 显示同步指示器
    function showSyncIndicator() {
      const syncStatus = document.getElementById('syncStatus');
      syncStatus.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i><span>同步中...</span>';
      syncStatus.classList.add('text-primary');
      
      setTimeout(() => {
        syncStatus.innerHTML = '<i class="fa fa-check-circle mr-1"></i><span>已同步</span>';
        syncStatus.classList.remove('text-primary');
      }, 500);
    }
    
    // 本地存储相关函数
    function getConfirmationData() {
      const data = localStorage.getItem('bidConfirmationData');
      return data ? JSON.parse(data) : {};
    }
    
    function getPeriodData() {
      const data = localStorage.getItem('periodData');
      return data ? JSON.parse(data) : {};
    }
    
    function getLogData() {
      const data = localStorage.getItem('logData');
      return data ? JSON.parse(data) : [];
    }
    
    function getPeopleData() {
      const data = localStorage.getItem('peopleData');
      return data ? JSON.parse(data) : ["张三", "李四", "王五", "赵六", "钱七", "孙八", "周九", "吴十"];
    }
    
    function getBidGroupsData() {
      const data = localStorage.getItem('bidGroupsData');
      return data ? JSON.parse(data) : [
        ["张三", "李四"],   // 标书1
        ["王五", "赵六"],   // 标书2
        ["钱七", "孙八"],   // 标书3
        ["周九", "吴十"]    // 标书4
      ];
    }
    
    function getBidCountData() {
      const data = localStorage.getItem('bidCountData');
      return data ? parseInt(JSON.parse(data)) : 4;
    }
    
    function saveToLocalStorage() {
      const confirmationData = getConfirmationData();
      
      // 初始化当前周期数据
      if (!confirmationData[currentPeriod]) {
        confirmationData[currentPeriod] = {};
      }
      
      // 保存每个标书的确认状态
      for (let i = 0; i < bidCount; i++) {
        const bid = i + 1;
        const group = bidGroups[i] || [];
        confirmationData[currentPeriod][bid] = {};
        
        group.forEach(person => {
          if (person) { // 只保存有值的人员
            const checkbox = document.querySelector(`input[data-period="${currentPeriod}"][data-bid="${bid}"][data-person="${person}"]`);
            confirmationData[currentPeriod][bid][person] = checkbox ? checkbox.checked : false;
          }
        });
      }
      
      localStorage.setItem('bidConfirmationData', JSON.stringify(confirmationData));
    }
    
    function savePeriodData() {
      const periodData = {};
      const periodItems = document.querySelectorAll('.period-item');
      
      periodItems.forEach(item => {
        const periodId = item.dataset.period;
        const name = item.querySelector('.font-medium').textContent;
        const dateText = item.querySelector('.text-gray-500').textContent;
        const [startDate, endDate] = dateText.split(' 至 ');
        
        periodData[periodId] = {
          name,
          startDate,
          endDate
        };
      });
      
      localStorage.setItem('periodData', JSON.stringify(periodData));
    }
    
    function savePeopleData() {
      localStorage.setItem('peopleData', JSON.stringify(people));
    }
    
    function saveBidGroupsData() {
      localStorage.setItem('bidGroupsData', JSON.stringify(bidGroups));
    }
    
    function saveBidCountData() {
      localStorage.setItem('bidCountData', JSON.stringify(bidCount));
    }
    
    function saveLogEntry(entry) {
      let logData = getLogData();
      logData.unshift(entry);
      
      // 限制日志数量，只保留最近100条
      if (logData.length > 100) {
        logData = logData.slice(0, 100);
      }
      
      localStorage.setItem('logData', JSON.stringify(logData));
    }
    
    function loadFromLocalStorage() {
      // 加载标书数量
      bidCount = getBidCountData();
      
      // 加载人员数据
      people = getPeopleData();
      
      // 加载标书分配数据
      bidGroups = getBidGroupsData();
      
      // 如果标书分配数据与当前标书数量不匹配，重置分配
      if (bidGroups.length !== bidCount) {
        resetBidGroups();
        saveBidGroupsData();
      }
      
      // 加载周期数据
      const periodData = getPeriodData();
      if (Object.keys(periodData).length > 0) {
        const periodsContainer = document.getElementById('periodsContainer');
        periodsContainer.innerHTML = '';
        
        // 按周期ID排序
        const sortedPeriodIds = Object.keys(periodData).sort((a, b) => parseInt(a) - parseInt(b));
        
        sortedPeriodIds.forEach(periodId => {
          const period = periodData[periodId];
          const periodItem = document.createElement('div');
          periodItem.className = `period-item bg-gray-50 p-3 rounded-lg border cursor-pointer transition-custom hover:border-primary ${parseInt(periodId) === currentPeriod ? 'active border-primary bg-primary/5' : 'border-gray-200'}`;
          periodItem.dataset.period = periodId;
          periodItem.innerHTML = `
            <div class="font-medium">${period.name}</div>
            <div class="text-sm text-gray-500 mt-1">${period.startDate} 至 ${period.endDate}</div>
            <div class="flex justify-end mt-2">
              <button class="edit-period text-primary text-xs flex items-center" data-period="${periodId}">
                <i class="fa fa-pencil mr-1"></i> 编辑
              </button>
            </div>
          `;
          
          periodsContainer.appendChild(periodItem);
          
          // 添加点击事件
          periodItem.addEventListener('click', function(e) {
            if (e.target.closest('.edit-period')) return;
            
            document.querySelectorAll('.period-item').forEach(el => {
              el.classList.remove('active', 'border-primary', 'bg-primary/5');
              el.classList.add('border-gray-200');
            });
            
            this.classList.add('active', 'border-primary', 'bg-primary/5');
            this.classList.remove('border-gray-200');
            
            currentPeriod = parseInt(this.dataset.period);
            updateCurrentPeriodContent();
            updatePeriodStats();
          });
          
          // 为编辑按钮添加事件
          periodItem.querySelector('.edit-period').addEventListener('click', function(e) {
            e.stopPropagation();
            openPeriodModal(periodId, 'edit');
          });
        });
      }
      
      // 加载日志数据
      const logData = getLogData();
      const logContainer = document.getElementById('log-container');
      
      if (logData.length > 0) {
        logContainer.innerHTML = '';
        logData.forEach(entry => {
          const periodItem = document.querySelector(`.period-item[data-period="${entry.period}"]`);
          const periodName = periodItem ? periodItem.querySelector('.font-medium').textContent : `周期 ${entry.period}`;
          
          let actionText = '';
          if (entry.action === 'confirm') actionText = '确认了';
          else if (entry.action === 'cancel') actionText = '取消了';
          else actionText = entry.action;
          
          const targetText = entry.bid === 'all' ? '所有标书' : `标书 #${entry.bid}`;
          
          const logEntry = document.createElement('div');
          logEntry.className = 'flex justify-between items-center p-1.5 border-b border-gray-100 last:border-0';
          logEntry.innerHTML = `
            <span><strong>${entry.person}</strong> ${actionText} ${periodName} 的 ${targetText}</span>
            <span class="text-gray-400">${entry.time}</span>
          `;
          
          logContainer.appendChild(logEntry);
        });
      }
    }
  </script>
</body>
</html>